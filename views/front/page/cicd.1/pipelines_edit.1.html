<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>流水线详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/public.css" media="all">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script src="/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="/js/xkube.js?v=1" charset="utf-8"></script>
    <script src="/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
          <form class="layui-form layui-form-pane" action="" lay-filter="UpdateInfo">
          		<div class="layui-form-item" style="margin-bottom:2px;">
                      <div class="layui-inline">
                          <label class="layui-form-label">ID</label>
                              <div class="layui-input-inline">
                                  <input type="hide" name="id" autocomplete="off" readonly="true" placeholder="" class="layui-input">
                              </div>
                      </div> 
                      <div class="layui-inline">
                          <label class="layui-form-label">名称</label>
                              <div class="layui-input-inline">
                                  <input type="text" name="cicd_name" autocomplete="off" placeholder="" class="layui-input">
                              </div>
                      </div>
          		</div>
              <div class="layui-form-item" pane=""  style="width:620px;">
                  <label class="layui-form-label">流水线类型</label>
                  <div class="layui-input-block">
                      <input type="radio" name="cicd_type" value="1" lay-filter="cicdType" title="阿里云流水线" checked="">
                      <input type="radio" name="cicd_type" value="2" lay-filter="cicdType" title="本地流水线" disabled>
                  </div>
              </div>    
<!-- xkube cicd config --> 
              <div id ="xkubeTpl">     
                <blockquote class="layui-elem-quote">
              		<div class="layui-form-item" style="margin-bottom:2px">
                          <div class="layui-inline">
                              <label class="layui-form-label">git地址</label>
                                  <div class="layui-input-inline" style="width:512px;">
                                      <input type="text" name="cicd_giturl" autocomplete="off" placeholder="" class="layui-input">
                                  </div>
                          </div>
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">
                  				<div class="layui-inline">
                    					<label class="layui-form-label">gitToken:</label>
                                <div class="layui-input-inline">
                  	            		<select name="cicd_type">
                  	              			<option value="1" selected="">wangbikang</option>
                  				  			      <option value="2">wangbikang</option>
                  	            		</select>
                                </div>
                  				</div>
                  				<div class="layui-inline">
                    					<label class="layui-form-label">分支:</label>
                    					<div class="layui-input-inline">
                      					<input type="text" name="cicd_image" placeholder="" autocomplete="off"  class="layui-input">
                    					</div>
                  				</div>
              		</div>	
                </blockquote>
                <blockquote class="layui-elem-quote">
              		<div class="layui-form-item" style="margin-bottom:2px">                                  
                			<div class="layui-inline">
        		  				    <label class="layui-form-label">任务类型</label>
                              <div class="layui-input-inline">
                	            		<select name="deploy_type" lay-filter="deployType" >
                	              			<option value="1" selected="">镜像构建部署</option>
                				  			      <option value="2">java编译构建部署</option>
                				  			      <option value="3">node编译构建部署</option>
                	            		</select>
                              </div>
                			</div>
              		</div>
                  <div id="javaTpl">
                		<div class="layui-form-item" style="margin-bottom:2px">                        
                  			<div class="layui-inline">
          		  				    <label class="layui-form-label">JDK版本:</label>
                                <div class="layui-input-inline">
                  	            		<select name="cicd_type">
                  	              			<option value="1" selected="">java-1.8</option>
                  				  			      <option value="2">java编译构建部署</option>
                  				  			      <option value="3">node编译构建部署</option>
                  	            		</select>
                                </div>
                  			</div>
                  			<div class="layui-inline">
          		  				    <label class="layui-form-label">maven版本:</label>
                                <div class="layui-input-inline">
                  	            		<select name="cicd_type">
                  	              			<option value="1" selected="">maven-3.5</option>
                  				  			      <option value="2">java编译构建部署</option>
                  				  			      <option value="3">node编译构建部署</option>
                  	            		</select>
                                </div>
                  			</div>
                		</div>	
                  </div>
                  <div id="nodejsTpl">
                		<div class="layui-form-item" style="margin-bottom:2px"> 
                  			<div class="layui-inline">
          		  				    <label class="layui-form-label">node版本:</label>
                                <div class="layui-input-inline">
                  	            		<select name="cicd_type">
                  	              			<option value="1" selected="">node-1.21</option>
                  				  			      <option value="2">java编译构建部署</option>
                  				  			      <option value="3">node编译构建部署</option>
                  	            		</select>
                                </div>
                  			</div>
                		</div>
                  </div>	
              		<div class="layui-form-item" style="margin-bottom:2px" id="buildCmdTpl"> 
                			<div class="layui-inline">
        		  				    <label class="layui-form-label">编译命令:</label>
                          <div class="layui-input-block">
                              <textarea name="ngxconf" style="width:512px" class="layui-textarea" lay-verify="" lay-reqtext="不能为空" placeholder="注意事项："></textarea>
                          </div>
                			</div>
              		</div>
                </blockquote>
                <blockquote class="layui-elem-quote">
              		<div class="layui-form-item" style="margin-bottom:2px">
                  				<div class="layui-inline">
                    					<label class="layui-form-label">镜像地址</label>
                    					<div class="layui-input-inline" style="width: 512px;">
                      					<input type="text" name="cicd_image" placeholder="" autocomplete="off"  class="layui-input">
                    					</div>
                  				</div>
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">
                  				<div class="layui-inline">
                    					<label class="layui-form-label">登录token</label>
                              <div class="layui-input-inline">
                	            		<select name="cicd_type">
                	              			<option value="1" selected="">wangbikang</option>
                				  			      <option value="2">wangbikang</option>
                	            		</select>
                              </div>
                  				</div>
                  				<div class="layui-inline">
                    					<label class="layui-form-label">镜像tag:</label>
                    					<div class="layui-input-inline">
                      					<input type="text" name="cicd_image" placeholder="" autocomplete="off"  class="layui-input">
                    					</div>
                  				</div>
              		</div>	
                </blockquote>
                <blockquote class="layui-elem-quote">
                  <div class="layui-form-item" style="margin-bottom:2px">
              		    <div class="layui-inline">
              		      	<label class="layui-form-label">集群ID</label>
              		      		<div class="layui-input-inline">
                              <select name="clusterId" lay-filter="cluster_Id" lay-search="" id="cluster_Id">
                                <option value="">请选择集群</option>
                              </select>
              		      		</div>
              		    </div>   
  
                 			<div class="layui-inline">
                  			<label class="layui-form-label">命名空间</label>
                  				<div class="layui-input-inline">
                    					<input type="text" name="namespace" placeholder="" autocomplete="off" class="layui-input">
                  				</div>
                 			</div>
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">
            	      	<div class="layui-inline">
            	          	<label class="layui-form-label">负载类型</label>
            	          		<div class="layui-input-inline">
            	            		<select name="res_type" lay-filter="StatusKey">
            	              			<option value="deploy" selected="">deployment</option>
            				  			      <option value="statefulset">statefulset</option>
            				  			      <option value="cronjob">cronjob</option>
            				  			      <option value="daemonset">daemonset</option>
            	            		</select>
            	          		</div>
            		  	  </div> 
  
             					<div class="layui-inline">
              					<label class="layui-form-label">负载名称</label>
              					<div class="layui-input-inline">
                						<input type="text" name="res_name" placeholder="" autocomplete="off" class="layui-input">
              					</div>
             					</div> 
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">
             					<div class="layui-inline">
              					<label class="layui-form-label">容器名称</label>
              					<div class="layui-input-inline">
                						<input type="text" name="container_name" placeholder="" autocomplete="off" class="layui-input">
              					</div>
             					</div> 
                  </div>
                </blockquote>
                <blockquote class="layui-elem-quote">
                  <div class="layui-form-item" style="margin-bottom:2px">
            	      	<div class="layui-inline">
            	          	<label class="layui-form-label">状态</label>
            	          		<div class="layui-input-inline">
            	            		<select name="status" lay-filter="StatusKey">
            	              			<option value="1" selected="">启用</option>
            				  			      <option value="0">禁用</option>
            	            		</select>
            	          		</div>
            		  	  </div> 
                  		<div class="layui-inline">
                    			<label class="layui-form-label">备注</label>
                    				<div class="layui-input-inline">
                      				<input type="text" name="remark" autocomplete="off" class="layui-input">
                    				</div>
                  		</div>   
                  </div>
                </blockquote>
              </div>
<!-- aliyun flow config -->
              <div id ="aliyunTpl">     
              		<div class="layui-form-item" style="margin-bottom:2px">                                
                    			<div class="layui-inline">
            		  				    <label class="layui-form-label">阿里云帐号</label>
                                  <div class="layui-input-inline">
                    	            		<select name="cicd_type">
                    	              			<option value="pcauto2020" selected="">pcauto2020</option>
                    				  			      <option value="pcauto2019">pcauto2019</option>
                    	            		</select>
                                  </div>
                    			</div>
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">   
                    			<div class="layui-inline">
            		  				    <label class="layui-form-label">组织ID</label>
                                  <div class="layui-input-inline">
                    	            		<select name="cicd_type">
                    	              			<option value="1" selected="">太平洋网网络</option>
                    				  			      <option value="2">汽车C端资讯开发帐号</option>
                    	            		</select>
                                  </div>
                    			</div>
              		</div>	
              		<div class="layui-form-item" style="margin-bottom:2px">   
                          <div class="layui-inline">
                              <label class="layui-form-label">流水线ID</label>
                                  <div class="layui-input-inline">
                                      <input type="text" name="cicd_name" autocomplete="off" placeholder="" class="layui-input">
                                  </div>
                          </div>
              		</div>	            
              </div>
                <div class="layui-form-item" id="updateBtn">
                      <button class="layui-btn" lay-submit="" lay-filter="updateSubmit">保存更改</button>
                </div>
                <div class="layui-form-item" id="addBtn">
                      <button class="layui-btn" lay-submit="" lay-filter="addSubmit">添加</button>
                </div>
        </form>         
    </div>
</div>
</body>
<script type="text/javascript">
    	$(document).ready(function(){
          //GetCurrClusterId();  
          //GetNamespace();	
    	});		
</script>


<script>

      var cicdName = getQueryString("cicdName");

    layui.use(['form', 'table','miniTab','element'], function () {
        var $ = layui.jquery,
            form = layui.form,
            element = layui.element,
            table = layui.table;
            miniTab = layui.miniTab,
            miniTab.listen();

        $("#updateBtn").show();
        $("#addBtn").hide();

        $("#xkubeTpl").hide();
        $("#aliyunTpl").show();

        form.on('radio(cicdType)', function (data) { 
            if(data.value == '2'){
              $("#xkubeTpl").show();
              $("#aliyunTpl").hide();
            }else{
              $("#xkubeTpl").hide();
              $("#aliyunTpl").show();        
            }  
        });

      //var nameSpace = getQueryString("nameSpace");
      //$('#appNameTitle').html(deployName);

      //deatail
			$.get('/cicd/v1/GetCicdInfo' + location.search, function (resp) {
				  if (resp.code == 0 ) {
              $("#updateBtn").show();
              $("#addBtn").hide();  
              if ( resp.data.cicd_type == 1 ) {
                $.get('/cicd/v1/GetPipelines?cicdId='+resp.data.cicd_id, function (resp2) {
        				  form.val('UpdateInfo', {
        				    "id": resp.data.id
                    ,"cicd_name": resp.data.cicd_name
                  	,"cicd_type": resp.data.cicd_type
                  	,"aliyun_id": resp2.data.aliyun_id
                  	,"organization_id": resp2.data.organization_id
                  	,"pipeline_id": resp2.data.pipeline_id
        				  });
                });                     
              }else if ( resp.data.cicd_type == 2 ) {        
                  $.get('/cicd/v1/GetCicdAllConfig' + location.search, function (resp2) {            
            				  form.val('UpdateInfo', {
            				    "id": resp.data.id
                        ,"cicd_name": resp.data.cicd_name
                      	,"cicd_type": resp.data.cicd_type
                      	,"remarks": resp2.data.remarks
            				  });   
                  }); 
              }             
          }else{
              $("#updateBtn").hide();
              $("#addBtn").show();
              console.log(cicdName);
    				  form.val('UpdateInfo', {
                "cicd_name": cicdName
    				  });
          }
		  });

/**
         $.ajax({
           url: "/xkube/job/v1/Log"+location.search,
           type: "GET",
           success: function (resp) {
              $('#logtext').html(resp);
            }
         });	
**/
        //添加
        form.on('submit(addSubmit)', function (data) {
                data.field.cicd_name = data.field.cicd_name.replace(/^\s*|\s*$/g,""); //替换空格
                data.field.cicd_type = data.field.cicd_type.replace(/^\s*|\s*$/g,"");
                data.field.pipeline_id = data.field.cicd_giturl.replace(/^\s*|\s*$/g,"");             
					      console.log(data.field);
			          layer.confirm('确定添加?', {icon: 3, title:'提示',yes: function(index){
                     var index2 = layer.load(0, {shade: false});
                     layer.msg('此处需运行3-5s左右');
                     $.ajax({
                        url: "/xkube/cicd/Add" + location.search,
                        type: "POST",
                        data: JSON.stringify(data.field),
                        dataType: "json",
                        success: function (resp) {
                              layer.close(index2);
                              if(resp.code == 0){
                                  layer.msg('添加成功', {icon: 1});
                              }else{
                                  layer.msg(resp.msg,{icon:2});
                              }
                        }
                      });		  	  
                  },
                  cancel: function(index, layero){ 
                    layer.close(index);
                    layer.close(index2);
		                console.log("不操作");
                  } 
                });
              return false;
        });

        //更新
        form.on('submit(updateSubmit)', function (data) {
                data.field.cicd_name = data.field.cicd_name.replace(/^\s*|\s*$/g,""); //替换空格
                data.field.namespace = data.field.namespace.replace(/^\s*|\s*$/g,"");
                data.field.cicd_giturl = data.field.cicd_giturl.replace(/^\s*|\s*$/g,"");
                data.field.cicd_image = data.field.cicd_image.replace(/^\s*|\s*$/g,"");                
					      console.log(data.field);
			          layer.confirm('确定修改?', {icon: 3, title:'提示',yes: function(index){
                     var index2 = layer.load(0, {shade: false});
                     layer.msg('此处需运行3-5s左右');
                     $.ajax({
                       url: "/xkube/cicd/Update" + location.search,
                       type: "POST",
                       data: JSON.stringify(data.field),
                       dataType: "json",
                       success: function (resp) {
                                layer.close(index2);
                                 if(resp.code == 0){
                                    layer.msg('修改成功', {icon: 1});
                                 }else{
                                    layer.msg(resp.msg,{icon:2});
                                 }
                        }
                      });		  	  
                  },
                  cancel: function(index, layero){ 
                    layer.close(index);
                    layer.close(index2);
		                console.log("不操作");
                  } 
                });
              return false;
        });

    });
</script>
</html>